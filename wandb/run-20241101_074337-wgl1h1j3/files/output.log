  0%|                                                                                                                                                                                                   | 0/390 [00:00<?, ?it/s]2024-11-01 07:43:49,488 - ERROR - Training failed: Caught RuntimeError in replica 0 on device 0.
Original Traceback (most recent call last):
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/parallel_apply.py", line 64, in _worker
    output = module(*input, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/SentenceTransformer.py", line 683, in forward
    return super().forward(input)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/container.py", line 217, in forward
    input = module(input)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/models/Transformer.py", line 350, in forward
    output_states = self.auto_model(**trans_features, **kwargs, return_dict=False)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 976, in forward
    encoder_outputs = self.encoder(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 620, in forward
    layer_outputs = self._gradient_checkpointing_func(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/utils/checkpoint.py", line 249, in checkpoint
    return CheckpointFunction.apply(function, preserve, *args)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/autograd/function.py", line 506, in apply
    return super().apply(*args, **kwargs)  # type: ignore[misc]
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/utils/checkpoint.py", line 107, in forward
    outputs = run_function(*args)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 520, in forward
    self_attention_outputs = self.attention(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 447, in forward
    self_outputs = self.self(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 233, in forward
    attention_scores = torch.matmul(query_layer, key_layer.transpose(-1, -2))
RuntimeError: CUDA error: CUBLAS_STATUS_EXECUTION_FAILED when calling `cublasSgemmStridedBatched( handle, opa, opb, m, n, k, &alpha, a, lda, stridea, b, ldb, strideb, &beta, c, ldc, stridec, num_batches)`

Traceback (most recent call last):
  File "/home/thiendc/projects/legal_retrieval/batch_train_v2.py", line 187, in <module>
    main()
  File "/home/thiendc/projects/legal_retrieval/batch_train_v2.py", line 179, in main
    trainer.train()
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/trainer.py", line 2052, in train
    return inner_training_loop(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/trainer.py", line 2388, in _inner_training_loop
    tr_loss_step = self.training_step(model, inputs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/trainer.py", line 3485, in training_step
    loss = self.compute_loss(model, inputs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/trainer.py", line 348, in compute_loss
    loss = loss_fn(features, labels)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MatryoshkaLoss.py", line 152, in forward
    loss += weight * self.loss(sentence_features, labels)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MultipleNegativesRankingLoss.py", line 101, in forward
    reps = [self.model(sentence_feature)["sentence_embedding"] for sentence_feature in sentence_features]
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MultipleNegativesRankingLoss.py", line 101, in <listcomp>
    reps = [self.model(sentence_feature)["sentence_embedding"] for sentence_feature in sentence_features]
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MatryoshkaLoss.py", line 41, in __call__
    output = self.fn(features)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/data_parallel.py", line 171, in forward
    outputs = self.parallel_apply(replicas, inputs, kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/data_parallel.py", line 181, in parallel_apply
    return parallel_apply(replicas, inputs, kwargs, self.device_ids[:len(replicas)])
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/parallel_apply.py", line 89, in parallel_apply
    output.reraise()
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/_utils.py", line 644, in reraise
    raise exception
RuntimeError: Caught RuntimeError in replica 0 on device 0.
Original Traceback (most recent call last):
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/parallel_apply.py", line 64, in _worker
    output = module(*input, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/SentenceTransformer.py", line 683, in forward
    return super().forward(input)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/container.py", line 217, in forward
    input = module(input)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/models/Transformer.py", line 350, in forward
    output_states = self.auto_model(**trans_features, **kwargs, return_dict=False)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 976, in forward
    encoder_outputs = self.encoder(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 620, in forward
    layer_outputs = self._gradient_checkpointing_func(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/utils/checkpoint.py", line 249, in checkpoint
    return CheckpointFunction.apply(function, preserve, *args)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/autograd/function.py", line 506, in apply
    return super().apply(*args, **kwargs)  # type: ignore[misc]
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/utils/checkpoint.py", line 107, in forward
    outputs = run_function(*args)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 520, in forward
    self_attention_outputs = self.attention(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 447, in forward
    self_outputs = self.self(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 233, in forward
    attention_scores = torch.matmul(query_layer, key_layer.transpose(-1, -2))
RuntimeError: CUDA error: CUBLAS_STATUS_EXECUTION_FAILED when calling `cublasSgemmStridedBatched( handle, opa, opb, m, n, k, &alpha, a, lda, stridea, b, ldb, strideb, &beta, c, ldc, stridec, num_batches)`

Traceback (most recent call last):
  File "/home/thiendc/projects/legal_retrieval/batch_train_v2.py", line 187, in <module>
    main()
  File "/home/thiendc/projects/legal_retrieval/batch_train_v2.py", line 179, in main
    trainer.train()
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/trainer.py", line 2052, in train
    return inner_training_loop(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/trainer.py", line 2388, in _inner_training_loop
    tr_loss_step = self.training_step(model, inputs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/trainer.py", line 3485, in training_step
    loss = self.compute_loss(model, inputs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/trainer.py", line 348, in compute_loss
    loss = loss_fn(features, labels)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MatryoshkaLoss.py", line 152, in forward
    loss += weight * self.loss(sentence_features, labels)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MultipleNegativesRankingLoss.py", line 101, in forward
    reps = [self.model(sentence_feature)["sentence_embedding"] for sentence_feature in sentence_features]
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MultipleNegativesRankingLoss.py", line 101, in <listcomp>
    reps = [self.model(sentence_feature)["sentence_embedding"] for sentence_feature in sentence_features]
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/losses/MatryoshkaLoss.py", line 41, in __call__
    output = self.fn(features)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/data_parallel.py", line 171, in forward
    outputs = self.parallel_apply(replicas, inputs, kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/data_parallel.py", line 181, in parallel_apply
    return parallel_apply(replicas, inputs, kwargs, self.device_ids[:len(replicas)])
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/parallel_apply.py", line 89, in parallel_apply
    output.reraise()
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/_utils.py", line 644, in reraise
    raise exception
RuntimeError: Caught RuntimeError in replica 0 on device 0.
Original Traceback (most recent call last):
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/parallel/parallel_apply.py", line 64, in _worker
    output = module(*input, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/SentenceTransformer.py", line 683, in forward
    return super().forward(input)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/container.py", line 217, in forward
    input = module(input)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/sentence_transformers/models/Transformer.py", line 350, in forward
    output_states = self.auto_model(**trans_features, **kwargs, return_dict=False)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 976, in forward
    encoder_outputs = self.encoder(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 620, in forward
    layer_outputs = self._gradient_checkpointing_func(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/utils/checkpoint.py", line 249, in checkpoint
    return CheckpointFunction.apply(function, preserve, *args)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/autograd/function.py", line 506, in apply
    return super().apply(*args, **kwargs)  # type: ignore[misc]
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/utils/checkpoint.py", line 107, in forward
    outputs = run_function(*args)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 520, in forward
    self_attention_outputs = self.attention(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 447, in forward
    self_outputs = self.self(
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1501, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/thiendc/projects/.thienenv/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py", line 233, in forward
    attention_scores = torch.matmul(query_layer, key_layer.transpose(-1, -2))
RuntimeError: CUDA error: CUBLAS_STATUS_EXECUTION_FAILED when calling `cublasSgemmStridedBatched( handle, opa, opb, m, n, k, &alpha, a, lda, stridea, b, ldb, strideb, &beta, c, ldc, stridec, num_batches)`
